#!/bin/bash
# Noosphere post-commit hook — flushes the buffer in the background.
# Never blocks the commit. Fails silently if the server is unreachable.
#
# Env vars (set in your shell profile or .env):
#   NOOSPHERE_URL        — server URL (default: http://localhost:3000)
#   NOOSPHERE_PROJECT_ID — project ID (default: derived from git remote or dirname)
#   NOOSPHERE_TOKEN      — auth token (optional, omit if auth is disabled)

NOOSPHERE_URL="${NOOSPHERE_URL:-http://localhost:3000}"

if [ -z "$NOOSPHERE_PROJECT_ID" ]; then
  if git remote get-url origin &>/dev/null; then
    RAW=$(git remote get-url origin)
    NOOSPHERE_PROJECT_ID=$(echo "$RAW" | sed 's|https\?://||; s|git@||; s|:|/|; s|\.git$||; s|.*@||')
  else
    NOOSPHERE_PROJECT_ID=$(basename "$(pwd)")
  fi
fi

AUTH_HEADER=""
if [ -n "$NOOSPHERE_TOKEN" ]; then
  AUTH_HEADER="-H \"Authorization: Bearer $NOOSPHERE_TOKEN\""
fi

# Fire-and-forget flush — runs in background, never blocks commit
(eval curl -s -X POST "$AUTH_HEADER" "$NOOSPHERE_URL/flush/$NOOSPHERE_PROJECT_ID" >/dev/null 2>&1) &
